--[[
  AntiExploit
  Responsibility: Basic rate limiting and sanity checks for server actions.
]]

local Players = game:GetService("Players")

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local ServiceLocator = require(ReplicatedStorage.Modules.Shared.ServiceLocator)

local AntiExploit = {}

local rateBuckets = {}

local function getBucket(player, key)
	local userId = player.UserId
	rateBuckets[userId] = rateBuckets[userId] or {}
	rateBuckets[userId][key] = rateBuckets[userId][key] or {count = 0, windowStart = os.clock()}
	return rateBuckets[userId][key]
end

function AntiExploit.CheckRateLimit(player, key, limit, windowSeconds)
	if not player or not player:IsDescendantOf(Players) then
		return false
	end

	local bucket = getBucket(player, key)
	local now = os.clock()
	if now - bucket.windowStart >= windowSeconds then
		bucket.windowStart = now
		bucket.count = 0
	end

	bucket.count += 1
	return bucket.count <= limit
end

function AntiExploit.IsCharacterValid(player)
	local character = player.Character
	if not character then
		return false
	end
	local humanoid = character:FindFirstChildOfClass("Humanoid")
	local root = character:FindFirstChild("HumanoidRootPart")
	if not humanoid or humanoid.Health <= 0 or not root then
		return false
	end
	return true
end

function AntiExploit.IsPositionSane(player, position, maxDistance)
	if not AntiExploit.IsCharacterValid(player) then
		return false
	end
	local root = player.Character.HumanoidRootPart
	local distance = (root.Position - position).Magnitude
	return distance <= maxDistance
end

Players.PlayerRemoving:Connect(function(player)
	rateBuckets[player.UserId] = nil
end)

ServiceLocator.Register("AntiExploit", AntiExploit)

return AntiExploit
